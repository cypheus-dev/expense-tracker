{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto">
    <div id="add-expense-form"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    ReactDOM.render(
        React.createElement(window.ExpenseUI.ContentCard, {
            title: "Dodaj nowy wydatek",
            children: React.createElement('form', {
                action: "{{ url_for('add_expense') }}",
                method: "POST",
                enctype: "multipart/form-data",
                className: "space-y-6"
            }, [
                // Sekcja kwoty i karty
                React.createElement('div', {
                    className: "grid grid-cols-1 md:grid-cols-2 gap-6"
                }, [
                    // Pole kwoty z wyborem waluty
                    React.createElement('div', { className: "form-group" }, [
                        React.createElement('label', {
                            className: "form-label",
                            htmlFor: "amount"
                        }, "Kwota"),
                        React.createElement('div', {
                            className: "flex"
                        }, [
                            React.createElement('input', {
                                type: "number",
                                step: "0.01",
                                name: "amount",
                                id: "amount",
                                required: true,
                                className: "form-input flex-1 rounded-l-lg rounded-r-none",
                                min: "0"
                            }),
                            React.createElement('select', {
                                name: "currency",
                                className: "form-select rounded-r-lg rounded-l-none border-l-0 w-24",
                                required: true
                            }, [
                                {% for value, label in currencies %}
                                React.createElement('option', {
                                    value: "{{ value }}"
                                }, "{{ label }}"),
                                {% endfor %}
                            ])
                        ])
                    ]),

                    // Wybór karty płatniczej
                    React.createElement('div', { className: "form-group" }, [
                        React.createElement('label', {
                            className: "form-label",
                            htmlFor: "card_id"
                        }, "Karta płatnicza"),
                        React.createElement('select', {
                            name: "card_id",
                            id: "card_id",
                            className: "form-select",
                            required: true,
                            onChange: (e) => updateCurrencyFromCard(e.target.value)
                        }, [
                            React.createElement('option', {
                                value: ""
                            }, "Wybierz kartę..."),
                            {% for card in cards %}
                            React.createElement('option', {
                                value: "{{ card.id }}",
                                'data-currency': "{{ card.currency }}"
                            }, "{{ card.name }} ({{ card.currency }})"),
                            {% endfor %}
                        ])
                    ])
                ]),

                // Data transakcji
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', {
                        className: "form-label",
                        htmlFor: "date"
                    }, "Data transakcji"),
                    React.createElement('input', {
                        type: "date",
                        name: "date",
                        id: "date",
                        required: true,
                        className: "form-input",
                        max: "{{ today }}",
                        defaultValue: "{{ today }}"
                    })
                ]),

                // Opis wydatku
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', {
                        className: "form-label",
                        htmlFor: "description"
                    }, "Opis (do kogo płatność oraz za co np. nr faktury, nr rezerwacji, nr imprezy)"),
                    React.createElement('textarea', {
                        name: "description",
                        id: "description",
                        required: true,
                        className: "form-textarea",
                        rows: "3"
                    })
                ]),

                // Załącznik faktury
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', {
                        className: "form-label",
                        htmlFor: "receipt"
                    }, "Dodaj plik z fakturą"),
                    React.createElement('input', {
                        type: "file",
                        name: "receipt",
                        id: "receipt",
                        className: "form-input",
                        accept: ".pdf,.jpg,.jpeg,.png"
                    }),
                    React.createElement('p', {
                        className: "text-sm text-gray-500 mt-1"
                    }, "Akceptowane formaty: PDF, JPG, PNG. Max rozmiar: 5MB")
                ]),

                // Przyciski akcji
                React.createElement('div', {
                    className: "flex gap-2"
                }, [
                    React.createElement(window.ExpenseUI.IconButton, {
                        type: "submit",
                        label: "Zapisz wydatek",
                        variant: "primary"
                    }),
                    React.createElement(window.ExpenseUI.IconButton, {
                        label: "Anuluj",
                        variant: "secondary",
                        href: "{{ url_for('index') }}"
                    })
                ])
            ])
        }),
        document.getElementById('add-expense-form')
    );
});

// Funkcja aktualizująca walutę na podstawie wybranej karty
function updateCurrencyFromCard(cardId) {
    if (!cardId) return;
    const cardOption = document.querySelector(`option[value="${cardId}"]`);
    if (!cardOption) return;
    
    const currency = cardOption.getAttribute('data-currency');
    if (currency) {
        const currencySelect = document.querySelector('select[name="currency"]');
        if (currencySelect) {
            currencySelect.value = currency;
        }
    }
}

// Walidacja przed wysłaniem
document.addEventListener('submit', function(e) {
    if (e.target.querySelector('#receipt')) {
        const fileInput = e.target.querySelector('#receipt');
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) { // 5MB
                e.preventDefault();
                alert('Plik jest za duży. Maksymalny rozmiar to 5MB.');
                return;
            }
        }
    }

    const dateInput = e.target.querySelector('#date');
    if (dateInput) {
        const selectedDate = new Date(dateInput.value);
        const today = new Date();
        if (selectedDate > today) {
            e.preventDefault();
            alert('Data nie może być z przyszłości.');
            return;
        }
    }
});
</script>
{% endblock %}