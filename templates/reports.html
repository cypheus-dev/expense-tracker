{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <!-- Stats Row -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div id="stats-pln"></div>
        <div id="stats-eur"></div>
        <div id="stats-count"></div>
        <div id="stats-pending"></div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div id="expenses-by-category"></div>
        <div id="expenses-timeline"></div>
    </div>

    <!-- Expense Details Section -->
    <div id="expense-details"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Stats Cards
    ReactDOM.render(
        React.createElement(window.ExpenseUI.StatCard, {
            title: "Suma PLN",
            value: "{{ '%.2f' % total_by_currency.get('PLN', 0) }} zł",
            subtitle: "W tym miesiącu",
            color: "primary"
        }),
        document.getElementById('stats-pln')
    );

    ReactDOM.render(
        React.createElement(window.ExpenseUI.StatCard, {
            title: "Suma EUR",
            value: "{{ '%.2f' % total_by_currency.get('EUR', 0) }} €",
            subtitle: "W tym miesiącu",
            color: "info"
        }),
        document.getElementById('stats-eur')
    );

    ReactDOM.render(
        React.createElement(window.ExpenseUI.StatCard, {
            title: "Liczba wydatków",
            value: "{{ expense_count }}",
            subtitle: "W tym miesiącu",
            color: "success"
        }),
        document.getElementById('stats-count')
    );

    ReactDOM.render(
        React.createElement(window.ExpenseUI.StatCard, {
            title: "Do zatwierdzenia",
            value: "{{ pending_count }}",
            subtitle: "Oczekujące wydatki",
            color: "warning"
        }),
        document.getElementById('stats-pending')
    );

    // Category Chart with Data
    const categoryData = [
        {% for category, amount in categories_data %}
        {
            name: "{{ category }}",
            value: {{ amount }},
            currency: "{{ currency }}"
        },
        {% endfor %}
    ];

    ReactDOM.render(
        React.createElement(window.ExpenseUI.ContentCard, {
            title: "Wydatki według kategorii",
            children: React.createElement('div', {
                id: 'category-chart',
                className: 'h-96'
            })
        }),
        document.getElementById('expenses-by-category')
    );

    // Timeline Data
    const timelineData = [
        {% for date, data in timeline %}
        {
            date: "{{ date }}",
            {% for currency, amount in data.items() %}
            {{ currency }}: {{ amount }},
            {% endfor %}
        },
        {% endfor %}
    ];

    ReactDOM.render(
        React.createElement(window.ExpenseUI.ContentCard, {
            title: "Wydatki w czasie",
            children: React.createElement('div', {
                id: 'timeline-chart',
                className: 'h-96'
            })
        }),
        document.getElementById('expenses-timeline')
    );

    // Expense Details Table
    ReactDOM.render(
        React.createElement(window.ExpenseUI.ContentCard, {
            title: "Szczegóły wydatków",
            action: React.createElement(window.ExpenseUI.IconButton, {
                label: "Eksportuj do Excel",
                variant: "success",
                href: "{{ url_for('export_expenses') }}"
            }),
            children: React.createElement(window.ExpenseUI.DataTable, {
                headers: [
                    "Data",
                    "Użytkownik",
                    "Kwota",
                    "Waluta",
                    "Status",
                    "Akcje"
                ],
                children: [
                    {% for expense in expenses %}
                    React.createElement('tr', { key: {{ expense.id }} }, [
                        React.createElement('td', {}, "{{ expense.date.strftime('%Y-%m-%d') }}"),
                        React.createElement('td', {}, "{{ expense.user.username }}"),
                        React.createElement('td', {}, "{{ '%.2f'|format(expense.amount) }}"),
                        React.createElement('td', {}, "{{ expense.currency }}"),
                        React.createElement('td', {}, 
                            React.createElement('span', {
                                className: 'badge bg-{{ expense.status_color }}'
                            }, "{{ expense.status }}")
                        ),
                        React.createElement('td', {}, 
                            React.createElement('div', { className: 'flex gap-2' }, [
                                {% if current_user.is_accountant %}
                                React.createElement(window.ExpenseUI.IconButton, {
                                    label: "Zatwierdź",
                                    variant: "success",
                                    size: "sm",
                                    onClick: () => approveExpense({{ expense.id }})
                                }),
                                React.createElement(window.ExpenseUI.IconButton, {
                                    label: "Odrzuć",
                                    variant: "danger",
                                    size: "sm",
                                    onClick: () => rejectExpense({{ expense.id }})
                                }),
                                {% endif %}
                                {% if expense.receipt_filename %}
                                React.createElement(window.ExpenseUI.IconButton, {
                                    label: "Pobierz fakturę",
                                    variant: "secondary",
                                    size: "sm",
                                    href: "{{ url_for('download_receipt', expense_id=expense.id) }}"
                                })
                                {% endif %}
                            ])
                        )
                    ]),
                    {% endfor %}
                ]
            })
        }),
        document.getElementById('expense-details')
    );

    // Initialize Charts
    initializeCategoryChart();
    initializeTimelineChart();
});

function initializeCategoryChart() {
    // Tu implementacja wykresu kategorii (można użyć Chart.js lub innej biblioteki)
    const ctx = document.getElementById('category-chart').getContext('2d');
    // Implementacja wykresu...
}

function initializeTimelineChart() {
    // Tu implementacja wykresu czasowego
    const ctx = document.getElementById('timeline-chart').getContext('2d');
    // Implementacja wykresu...
}

function approveExpense(expenseId) {
    // Implementacja zatwierdzania wydatku
    fetch(`/approve_expense/${expenseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    });
}

function rejectExpense(expenseId) {
    // Implementacja odrzucania wydatku
    fetch(`/reject_expense/${expenseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    });
}
</script>

<!-- Dodajemy potrzebne biblioteki do wykresów -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}