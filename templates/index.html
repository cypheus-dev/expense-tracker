{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
    <!-- Filters Section -->
    <div id="filters-section"></div>
    
    <!-- Expenses List -->
    <div id="expenses-list"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Render Filters Card
    ReactDOM.render(
        React.createElement(window.ExpenseUI.ContentCard, {
            title: "Filtry",
            children: React.createElement('form', {
                action: "{{ url_for('index') }}",
                method: "GET",
                className: "grid grid-cols-1 md:grid-cols-3 gap-4"
            }, [
                {% if current_user.is_accountant %}
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', { 
                        className: "form-label" 
                    }, "Użytkownik"),
                    React.createElement('select', {
                        name: "user_id",
                        className: "form-select",
                        defaultValue: "{{ filters.user_id }}"
                    }, [
                        React.createElement('option', { value: "" }, "Wszyscy użytkownicy"),
                        {% for user in users %}
                        React.createElement('option', { 
                            value: "{{ user.id }}"
                        }, "{{ user.username }}"),
                        {% endfor %}
                    ])
                ]),
                {% endif %}
                
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', { 
                        className: "form-label" 
                    }, "Data od"),
                    React.createElement('input', {
                        type: "date",
                        name: "date_from",
                        className: "form-input",
                        defaultValue: "{{ filters.date_from }}"
                    })
                ]),
                
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', { 
                        className: "form-label" 
                    }, "Data do"),
                    React.createElement('input', {
                        type: "date",
                        name: "date_to",
                        className: "form-input",
                        defaultValue: "{{ filters.date_to }}"
                    })
                ]),
                
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', { 
                        className: "form-label" 
                    }, "Kwota od"),
                    React.createElement('input', {
                        type: "number",
                        step: "0.01",
                        name: "amount_min",
                        className: "form-input",
                        defaultValue: "{{ filters.amount_min }}"
                    })
                ]),
                
                React.createElement('div', { className: "form-group" }, [
                    React.createElement('label', { 
                        className: "form-label" 
                    }, "Kwota do"),
                    React.createElement('input', {
                        type: "number",
                        step: "0.01",
                        name: "amount_max",
                        className: "form-input",
                        defaultValue: "{{ filters.amount_max }}"
                    })
                ]),
                
                React.createElement('div', { 
                    className: "col-span-full flex gap-2" 
                }, [
                    React.createElement(window.ExpenseUI.IconButton, {
                        type: "submit",
                        label: "Filtruj",
                        variant: "primary"
                    }),
                    React.createElement(window.ExpenseUI.IconButton, {
                        label: "Wyczyść filtry",
                        variant: "secondary",
                        href: "{{ url_for('index') }}"
                    })
                ])
            ])
        }),
        document.getElementById('filters-section')
    );

    // Render Expenses List
    ReactDOM.render(
        React.createElement(window.ExpenseUI.ContentCard, {
            title: {% if current_user.is_accountant %}"Wszystkie wydatki"{% else %}"Moje wydatki"{% endif %},
            action: React.createElement('div', { 
                className: "flex gap-2" 
            }, [
                React.createElement(window.ExpenseUI.IconButton, {
                    label: "Nowy wydatek",
                    variant: "primary",
                    href: "{{ url_for('add_expense') }}"
                }),
                {% if current_user.is_accountant %}
                React.createElement(window.ExpenseUI.IconButton, {
                    label: "Eksport do Excel",
                    variant: "success",
                    href: "{{ url_for('export_expenses') }}"
                })
                {% endif %}
            ]),
            children: [
                React.createElement('div', { className: "mb-4" }, [
                    React.createElement('div', { 
                        className: "btn-group btn-group-sm",
                        role: "group",
                        'aria-label': "Sortowanie"
                    }, [
                        React.createElement('a', {
                            href: "{{ url_for('index', sort='desc', page=pagination.page) }}",
                            className: "btn btn-outline-secondary {{ 'active' if current_sort == 'desc' }}",
                            title: "Sortuj od najnowszych"
                        }, "↓"),
                        React.createElement('a', {
                            href: "{{ url_for('index', sort='asc', page=pagination.page) }}",
                            className: "btn btn-outline-secondary {{ 'active' if current_sort == 'asc' }}",
                            title: "Sortuj od najstarszych"
                        }, "↑")
                    ])
                ]),
                React.createElement(window.ExpenseUI.DataTable, {
                    headers: [
                        "Data transakcji",
                        "Kwota",
                        "Karta",
                        "Opis",
                        {% if current_user.is_accountant %}"Użytkownik", "Status",{% endif %}
                        "Faktura",
                        "Akcje"
                    ],
                    children: {% raw %}[{% endraw %}
                        {% for expense in expenses %}
                        React.createElement('tr', { key: {{ expense.id }} }, [
                            React.createElement('td', {}, "{{ expense.date.strftime('%Y-%m-%d') }}"),
                            React.createElement('td', {}, "{{ expense.amount|format_currency(expense.currency) }}"),
                            React.createElement('td', {}, 
                                React.createElement('span', { 
                                    className: "badge bg-secondary" 
                                }, "{{ expense.card.name if expense.card else 'Brak karty' }}")
                            ),
                            React.createElement('td', {}, "{{ expense.description }}"),
                            {% if current_user.is_accountant %}
                            React.createElement('td', {}, "{{ expense.user.username }}"),
                            React.createElement('td', {}, 
                                React.createElement('span', { 
                                    className: "badge bg-{{ expense.status_color }}" 
                                }, "{{ expense.status }}")
                            ),
                            {% endif %}
                            React.createElement('td', {}, 
                                {% if expense.receipt_filename %}
                                React.createElement(window.ExpenseUI.IconButton, {
                                    variant: "secondary",
                                    size: "sm",
                                    href: "{{ url_for('download_receipt', expense_id=expense.id) }}",
                                    label: "Pobierz"
                                })
                                {% endif %}
                            ),
                            React.createElement('td', {}, 
                                React.createElement('div', { className: "flex gap-2" }, [
                                    {% if current_user.is_accountant or expense.user_id == current_user.id %}
                                    React.createElement(window.ExpenseUI.IconButton, {
                                        variant: "secondary",
                                        size: "sm",
                                        href: "{{ url_for('edit_expense', expense_id=expense.id) }}",
                                        label: "Edytuj"
                                    }),
                                    {% endif %}
                                    {% if current_user.is_admin or expense.user_id == current_user.id %}
                                    React.createElement(window.ExpenseUI.IconButton, {
                                        variant: "danger",
                                        size: "sm",
                                        onClick: () => deleteExpense({{ expense.id }}),
                                        label: "Usuń"
                                    })
                                    {% endif %}
                                ])
                            )
                        ]),
                        {% endfor %}
                    {% raw %}]{% endraw %}
                }),
                {% if pagination and pagination.pages > 1 %}
                React.createElement('nav', { 
                    className: "flex justify-center mt-4",
                    'aria-label': "Paginacja"
                }, 
                    React.createElement('ul', { className: "pagination" }, [
                        React.createElement('li', { 
                            className: "page-item {{ 'disabled' if not pagination.has_prev }}"
                        },
                            React.createElement('a', {
                                className: "page-link",
                                href: "{{ url_for('index', page=pagination.prev_num, sort=current_sort) if pagination.has_prev else '#' }}"
                            }, "«")
                        ),
                        {% for page in pagination.iter_pages() %}
                            {% if page %}
                            React.createElement('li', { 
                                className: "page-item {{ 'active' if page == pagination.page }}"
                            },
                                React.createElement('a', {
                                    className: "page-link",
                                    href: "{{ url_for('index', page=page, sort=current_sort) }}"
                                }, "{{ page }}")
                            ),
                            {% else %}
                            React.createElement('li', { className: "page-item disabled" },
                                React.createElement('span', { className: "page-link" }, "...")
                            ),
                            {% endif %}
                        {% endfor %}
                        React.createElement('li', { 
                            className: "page-item {{ 'disabled' if not pagination.has_next }}"
                        },
                            React.createElement('a', {
                                className: "page-link",
                                href: "{{ url_for('index', page=pagination.next_num, sort=current_sort) if pagination.has_next else '#' }}"
                            }, "»")
                        )
                    ])
                )
                {% endif %}
            ]
        }),
        document.getElementById('expenses-list')
    );
});

function deleteExpense(expenseId) {
    if (confirm('Czy na pewno chcesz usunąć ten wydatek?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        // Konstruujemy URL bezpośrednio
        form.action = `/delete_expense/${expenseId}`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = "{{ delete_form.csrf_token._value() }}";
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}